{% extends "pybo/base.html" %}
{% load static %}

{% block content %}

<!-- ========================================================================================== -->
<!-- ğŸ“Œ í–„ë²„ê±° ë²„íŠ¼ (ê³¼ê±° ëŒ€í™” ì—´ê¸°/ë‹«ê¸° í† ê¸€) -->
<button id="toggle-history-btn" aria-label="ê³¼ê±° ëŒ€í™” ì—´ê¸°" title="ê³¼ê±° ëŒ€í™” ì—´ê¸°">
  &#9776;
</button>

<div class="chat-container">

  <!-- ğŸ“Œ ì¢Œì¸¡ ì‚¬ì´ë“œë°” (ê³¼ê±° ëŒ€í™” ëª©ë¡ í‘œì‹œ ì˜ì—­) -->
  <aside class="chat-sidebar" id="chat-sidebar" aria-label="ê³¼ê±° ëŒ€í™” ëª©ë¡">
    <h2></h2>
    <!-- ì„ íƒ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
    <button id="select-mode-toggle" class="select-mode-toggle" title="ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ">
      <i class="fas fa-check"></i>
    </button>
    
    <!-- ë‹¤ì¤‘ ì‚­ì œ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
    <div class="bulk-delete-controls" id="bulk-delete-controls" style="display: none;">
      <div class="bulk-delete-header">
        <span id="selected-count">0ê°œ</span>
        <button id="bulk-delete-btn" class="btn btn-danger btn-sm" disabled>ì„ íƒ<br>ì‚­ì œ</button>
        <button id="select-all-btn" class="btn btn-outline-secondary btn-sm">ì „ì²´<br>ì„ íƒ</button>
      </div>
    </div>
    
    <ul id="history-list">
      {% for history in histories %}
        <!-- ğŸ ê³¼ê±° ëŒ€í™” í•­ëª© (ì„¸ì…˜ë³„) -->
        <!-- data-id ì†ì„±ì— ì„¸ì…˜ ID ì €ì¥ â†’ í´ë¦­ ì‹œ í•´ë‹¹ ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° -->
        <li data-id="{{ history.id }}" class="history-item" tabindex="0">
          <!-- ì²´í¬ë°•ìŠ¤ (ë‹¤ì¤‘ ì„ íƒìš©) -->
          <input type="checkbox" class="history-checkbox" value="{{ history.id }}" style="display: none;">
          <!-- ëŒ€í™” ì œëª© í‘œì‹œ -->
          <span class="history-title">{{ history.title }}</span>
          <!-- ì‚­ì œ ë²„íŠ¼ (ê°œë³„ ì„¸ì…˜ ì‚­ì œ) -->
          <button class="delete-btn" onclick="deleteSession('{{ history.id }}')" title="ì‚­ì œ">
            <i class="fas fa-xmark"></i>
          </button>
        </li>
      {% empty %}
        <!-- ê³¼ê±° ëŒ€í™”ê°€ ì—†ì„ ê²½ìš° -->
        <li>ê³¼ê±° ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endfor %}
    </ul>
  </aside>

  <!-- ğŸ“Œ ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
  <main class="chat-wrap" role="main">
    <div class="chat-card">

      <!-- ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
      <div class="chat-messages" id="chat-messages" tabindex="0">
        {% for m in messages %}
          {% if m.role == "user" %}
            <!-- ì‚¬ìš©ì ë©”ì‹œì§€ -->
            <div class="message user-message" id="msg-{{ m.id }}">
              {{ m.content|linebreaksbr }}
              <div class="timestamp">{{ m.created_at|date:"Y-m-d H:i" }}</div>  <!-- âœ… ì¶”ê°€ -->
            </div>
          {% elif m.role == "assistant" %}
            <div class="bot-message-wrapper">
              <i class="fab fa-github-alt bot-floating-icon"></i>
              <div class="message bot-message" id="msg-{{ m.id }}">
                {{ m.content|safe }}
                <div class="timestamp">{{ m.created_at|date:"Y-m-d H:i" }}</div>  <!-- âœ… ì¶”ê°€ -->
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="bot-message-wrapper">
            <i class="fab fa-github-alt bot-floating-icon"></i>
            <div class="message bot-message">
              ì•ˆë…•í•˜ì„¸ìš”! ì–´ë””ë¡œ ê°€ì‹¤ ì˜ˆì •ì¸ê°€ìš”?
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- ì…ë ¥ì°½ (ì‚¬ìš©ì ì…ë ¥ Form) -->
      <form class="chat-input" id="chat-form" action="/chatbot/" method="post">
        {% csrf_token %}
        <!-- ì‚¬ìš©ì ì…ë ¥ í•„ë“œ -->
        <input type="text" id="chat-input-box" placeholder="ì—¬í–‰ í”Œëœì„ ì…ë ¥í•´ì£¼ì„¸ìš” âœˆï¸" autocomplete="off">
        <!-- ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ -->
        <button type="submit" class="btn-send">ë³´ë‚´ê¸°</button>
      </form>

      <!-- ì¼ì • ì €ì¥ ë° ë§µ ë³´ê¸° ë²„íŠ¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
      <div class="schedule-save-container" id="scheduleButtons" style="display: none;">
        <button id="saveScheduleBtn" class="btn btn-custom2" disabled>ì´ ì¼ì • ì €ì¥í•˜ê¸°</button>
        <button id="viewOnMapBtn" class="btn btn-custom3" disabled>ë§µì—ì„œ ë³´ê¸°</button>
        <button id="showMapBtn" class="btn btn-custom" disabled>ì§€ë„ ë³´ê¸°</button>
      </div>

    </div>
    
    <!-- ì§€ë„ ì˜ì—­ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
    <div class="map-area" id="map-area" style="display:none;">
      <div class="map-header">
        <h4>ğŸ—ºï¸ ì¶”ì²œ ì¥ì†Œ ì§€ë„</h4>
        <button id="hideMapBtn" class="btn btn-sm btn-outline-light">ì§€ë„ ìˆ¨ê¸°ê¸°</button>
      </div>
      <div id="chatbot-map" class="map-container-inner"></div>
    </div>
  </main>
</div>

<!-- ========================================================================================== -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}"></script>
<!-- ì±—ë´‡ ì „ìš© CSS -->
<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">

<!-- ë‚´ ì»¤ìŠ¤í…€ css (bootstrap ë’¤ì— ìˆì–´ì•¼ ë®ì–´ì“°ê¸° ê°€ëŠ¥) -->
<link href="{% static 'css/custom-buttons.css' %}" rel="stylesheet">

<!-- ì±—ë´‡ ì „ìš© JavaScript -->
<script src="{% static 'js/chatbot.js' %}"></script>


{% endblock %}