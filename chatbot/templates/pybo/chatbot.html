{% extends "pybo/base.html" %}
{% load static %}

{% block content %}

<!-- ========================================================================================== -->
<!-- ê³¼ê±°ì±„íŒ… ë²„íŠ¼ (í–„ë²„ê±° ì•„ì´ì½˜) -->
<button id="toggle-history-btn" aria-label="ê³¼ê±° ëŒ€í™” ì—´ê¸°" title="ê³¼ê±° ëŒ€í™” ì—´ê¸°">
  &#9776;
</button>

<div class="chat-container">

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <aside class="chat-sidebar" id="chat-sidebar" aria-label="ê³¼ê±° ëŒ€í™” ëª©ë¡">
    <h2></h2>
    <ul id="history-list">
      {% for history in histories %}
        <!-- ğŸ â° ë©”ì‹œì§€ IDë¥¼ data-id ì†ì„±ìœ¼ë¡œ ì €ì¥ -->
        <li data-id="{{ history.id }}" class="history-item" tabindex="0">
          <span class="history-title">{{ history.title }}</span>
          <button class="delete-btn" onclick="deleteSession('{{ history.id }}')" title="ì‚­ì œ">Ã—</button>
        </li>
      {% empty %}
        <li>ê³¼ê±° ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endfor %}
    </ul>
  </aside>

  <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
  <main class="chat-wrap" role="main">
    <div class="chat-card">

      <!-- ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
      <div class="chat-messages" id="chat-messages" tabindex="0">
        {% for m in messages %}
          {% if m.role == "user" %}
            <div class="message user-message" id="msg-{{ m.id }}">{{ m.content|linebreaksbr }}</div>
          {% elif m.role == "assistant" %}
            <div class="message bot-message" id="msg-{{ m.id }}">{{ m.content|safe }}</div>
          {% endif %}
        {% empty %}
          <div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ì–´ë””ë¡œ ê°€ì‹¤ ì˜ˆì •ì¸ê°€ìš”?</div>
        {% endfor %}
      </div>

      <!-- ì…ë ¥ì°½ (formì— action, method ì§€ì •) -->
      <form class="chat-input" id="chat-form" action="/chatbot/" method="post">
        {% csrf_token %}
        <input type="text" id="chat-input-box" placeholder="ì—¬í–‰ í”Œëœì„ ì…ë ¥í•´ì£¼ì„¸ìš” âœˆï¸" autocomplete="off">
        <button type="submit" class="btn-send">ë³´ë‚´ê¸°</button>
      </form>

      <!-- ì¼ì • ì €ì¥ ë²„íŠ¼ -->
      <div class="schedule-save-container">
        <button id="saveScheduleBtn" class="btn btn-primary" disabled>ì´ ì¼ì • ì €ì¥í•˜ê¸°</button>
      </div>

    </div>
  </main>
</div>

<!-- ========================================================================================== -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // âœ… CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const CSRF_TOKEN = getCookie('csrftoken');  // Djangoê°€ ë°œê¸‰í•œ csrftoken ì¿ í‚¤ ì½ê¸°

  // âœ… ë§ˆì§€ë§‰ ì¼ì • ë°ì´í„° (ì±—ë´‡ì´ ë§Œë“  ì—¬í–‰ ì¼ì • ì €ì¥ìš©)
  let lastScheduleData = null;

  // âœ… ì±„íŒ…ì°½ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
  function scrollToBottom() {
    const chatBox = document.getElementById("chat-messages");
    if (chatBox) {
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }

  // âœ… ë©”ì‹œì§€ ì „ì†¡ (ì‚¬ìš©ì ì…ë ¥ â†’ Django chatbot_view POST)
  async function sendMessage(event) {
    event.preventDefault(); // form ê¸°ë³¸ ì œì¶œ ë§‰ê¸°
    const input  = document.getElementById("chat-input-box");
    const chatBox = document.getElementById("chat-messages");
    const userText = input.value;
    if (!userText.trim()) return; // ê³µë°±ë§Œ ì…ë ¥ ë°©ì§€

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¦‰ì‹œ í™”ë©´ì— ì¶œë ¥
    chatBox.insertAdjacentHTML('beforeend', `<div class="message user-message"></div>`);
    chatBox.lastElementChild.textContent = userText;
    input.value = "";
    scrollToBottom();

    try {
      // ğŸš¨ ì—¬ê¸° URLì„ "" â†’ "/chatbot/" ìœ¼ë¡œ ëª…í™•íˆ ì§€ì •
      const response = await fetch("/chatbot/", {
        method: "POST",
        headers: { 
          "X-CSRFToken": CSRF_TOKEN,  // Django CSRF ë³´í˜¸ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ í•„ìš”
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ message: userText }) // ì„œë²„ì— ë³´ë‚¼ ë°ì´í„°
      });

      if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
      const data = await response.json();

      // ë¡œê·¸ì¸ í•„ìš”í•  ê²½ìš° ì²˜ë¦¬
      if (data.login_required) {
        if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          window.location.href = "/login/";
        }
        return;
      }

      // ì¼ë°˜ í…ìŠ¤íŠ¸ ì‘ë‹µ
      if (!data.yt_html && data.reply) {
        const mdHtml = marked.parse(data.reply);
        const botMsg = document.createElement("div");
        botMsg.className = "message bot-message";
        botMsg.innerHTML = mdHtml;
        chatBox.appendChild(botMsg);
        convertYoutubeLinks(botMsg);
        scrollToBottom();
      }

      // ìœ íŠœë¸Œ ì¹´ë“œ ì‘ë‹µ
      if (data.yt_html) {
        const ytMsg = document.createElement("div");
        ytMsg.className = "message bot-message";
        ytMsg.innerHTML = `<div class="intro-text"><b>${userText}</b> ê´€ë ¨ ë¸Œì´ë¡œê·¸ ì¶”ì²œ ì˜ìƒì…ë‹ˆë‹¤ ğŸ˜Š</div>${data.yt_html}`;
        chatBox.appendChild(ytMsg);
        scrollToBottom();
      }

      // ì¼ì •ì´ ê°ì§€ë˜ë©´ ì €ì¥ ë²„íŠ¼ í™œì„±í™”
      if (data.reply && (data.reply.includes("Day") || data.reply.includes("ì¼ì°¨"))) {
        lastScheduleData = {
          title: userText,
          data: {
            query: userText,
            schedule: data.reply,
            places: data.map || [],
            created_at: new Date().toISOString()
          }
        };
        const saveBtn = document.getElementById("saveScheduleBtn");
        if (saveBtn) {
          saveBtn.style.display = "block";
          saveBtn.disabled = false;
        }
      }

    } catch (err) {
      chatBox.insertAdjacentHTML('beforeend', `<div class="message bot-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
      console.error(err);
      scrollToBottom();
    }
  }
  document.getElementById('chat-form').addEventListener('submit', sendMessage);

  // âœ… ì¼ì • ì €ì¥ ê¸°ëŠ¥ (ì¼ì • ì €ì¥ API í˜¸ì¶œ)
  document.getElementById("saveScheduleBtn").addEventListener("click", async function() {
    if (!lastScheduleData) {
        alert("ì €ì¥í•  ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì±—ë´‡ì—ê²Œ ì¼ì •ì„ ë°›ì•„ë³´ì„¸ìš”!");
        return;
    }
    this.disabled = true;
    
    try {
        const response = await fetch("/save_schedule/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": CSRF_TOKEN
            },
            body: JSON.stringify({
                title: lastScheduleData.title || "ìƒˆ ì—¬í–‰ ì¼ì •",
                data: {
                    ...lastScheduleData.data,
                    savedAt: new Date().toISOString()
                }
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            if (response.status === 401) {
                if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    window.location.href = "/login/";
                }
                return;
            }
            throw new Error(data.error || "ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        }

        if (data.success) {
            // ì‚¬ì´ë“œë°” íˆìŠ¤í† ë¦¬ì— ìƒˆ ì¼ì • ì¶”ê°€
            const historyList = document.getElementById("history-list");
            const emptyMessage = historyList.querySelector("li:not(.history-item)");
            if (emptyMessage) emptyMessage.remove();
            
            const newItem = document.createElement("li");
            newItem.className = "history-item";
            newItem.setAttribute("data-id", data.id);
            newItem.setAttribute("tabindex", "0");
            newItem.innerHTML = `
                <span class="history-title">${lastScheduleData.title}</span>
                <button class="delete-btn" onclick="deleteSession('${data.id}')" title="ì‚­ì œ">Ã—</button>
            `;
            historyList.insertBefore(newItem, historyList.firstChild);
            
            alert("ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            lastScheduleData = null;
            this.disabled = true;
        } else {
            alert(data.error || "ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            this.disabled = false;
        }
    } catch (err) {
        console.error("ì¼ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
        alert(err.message || "ì¼ì •ì„ ì €ì¥í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        this.disabled = false;
    }
  });

  // âœ… ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜
  function convertYoutubeLinks(container) {
    container.querySelectorAll("a").forEach(a => {
      const url = a.href;
      if (url.includes("youtube.com/watch") || url.includes("youtu.be")) {
        const videoId = url.split("v=")[1]?.split("&")[0] || url.split("/").pop();
        if (videoId) {
          a.outerHTML = `<iframe width="560" height="315"
            src="https://www.youtube.com/embed/${videoId}"
            frameborder="0" allowfullscreen></iframe>`;
        }
      } else {
        a.target = "_blank"; a.rel = "noopener";
      }
    });
  }

  // âœ… ëŒ€í™”ë‚´ì—­ ì‚­ì œ
  async function deleteSession(sessionId) {
    if (!confirm("ì´ ëŒ€í™”ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      const response = await fetch(`/delete_session/${sessionId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN }
      });
      if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
      const data = await response.json();
      if (data.success) {
        const item = document.querySelector(`.history-item[data-id="${sessionId}"]`);
        if (item) item.remove();
      } else if (data.login_required) {
        window.location.href = "/login/";
      } else {
        alert(data.error || "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (err) {
      console.error("ëŒ€í™”ë‚´ì—­ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
      alert("ëŒ€í™”ë‚´ì—­ì„ ì‚­ì œí•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // âœ… ì‚¬ì´ë“œë°” í† ê¸€ (í–„ë²„ê±° ë²„íŠ¼)
  const toggleBtn = document.getElementById("toggle-history-btn");
  const sidebar = document.getElementById("chat-sidebar");
  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("open");
  });

  // âœ… ê³¼ê±° ì„¸ì…˜ í´ë¦­ â†’ ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
  document.querySelectorAll(".history-item").forEach(item => {
    item.addEventListener("click", async (e) => {
      if (!e.target.classList.contains('delete-btn')) {
        const sessionId = item.getAttribute("data-id");
        try {
          const res = await fetch(`/load_session/${sessionId}/`);
          if (!res.ok) throw new Error("ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          const data = await res.json();

          const chatBox = document.getElementById("chat-messages");
          chatBox.innerHTML = ""; // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°

          data.messages.forEach(m => {
            const div = document.createElement("div");
            div.classList.add("message");
            div.classList.add(m.role === "user" ? "user-message" : "bot-message");
            div.innerHTML = m.content;
            chatBox.appendChild(div);
          });

          scrollToBottom();
        } catch (err) {
          console.error("ì„¸ì…˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
          alert("ì„¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
    });
  });
</script>
{% endblock %}
