{% extends 'pybo/base.html' %}
{% block body_class %}travel-map{% endblock %}
{% load static %}

{% block content %}
<!-- ì§€ë„ í˜ì´ì§€ ì „ìš© CSS -->
<link rel="stylesheet" href="{% static 'css/map.css' %}">
<!-- ë‚´ ì»¤ìŠ¤í…€ css (bootstrap ë’¤ì— ìˆì–´ì•¼ ë®ì–´ì“°ê¸° ê°€ëŠ¥) -->
<link href="{% static 'css/custom-buttons.css' %}" rel="stylesheet">

<div class="d-flex main-container">
    <!-- ì™¼ìª½ ê²€ìƒ‰/ëª©ë¡ (í† ê¸€ ê°€ëŠ¥) -->
    <aside class="p-3 bg-light sidebar-toggle left-sidebar" id="left-sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ì¥ì†Œ ê²€ìƒ‰</h5>
            <button class="btn btn-sm btn-outline-secondary" id="toggle-search">ê²€ìƒ‰</button>
        </div>
        
        <!-- íƒ­ ë²„íŠ¼ -->
        <ul class="nav nav-tabs mb-2" id="sidebarTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-tab="search">ì¥ì†Œ ê²€ìƒ‰</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="directions-tab" data-bs-toggle="tab" data-tab="directions">ê¸¸ì°¾ê¸°</button>
            </li>
        </ul>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="tabContents">
            <!-- ì¥ì†Œ ê²€ìƒ‰ íƒ­ -->
            <div class="tab-content" id="searchTabContent">
                <input type="text" id="search-input" class="form-control mb-2" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                <button class="btn btn-custom w-100 mb-3" id="search-button">ê²€ìƒ‰</button>
            
            
                <div class="scrollable">
                    <ul class="list-group" id="place-list"></ul>
                </div>

            </div>

            <!-- ê¸¸ì°¾ê¸° íƒ­ -->
            <div class="tab-content d-none" id="directionsTabContent">
                <h6>ì¶œë°œì§€</h6>
                <select id="start-point" class="form-select mb-2">
                    <option value="">ì¶œë°œì§€ ì„ íƒ</option>
                </select>
                <h6>ë„ì°©ì§€</h6>
                <select id="end-point" class="form-select mb-2">
                    <option value="">ë„ì°©ì§€ ì„ íƒ</option>
                </select>
                <h6>ê²½ìœ ì§€</h6>
                <div id="waypoints-container"></div>
                <!-- ì´ë™ ìˆ˜ë‹¨ ì„ íƒ -->
                <h6>ì´ë™ ìˆ˜ë‹¨</h6>
                <select id="transport-select" class="form-select mb-2">
                    <option value="RECOMMEND">ì¶”ì²œ</option>
                    <option value="TRANSIT">ëŒ€ì¤‘êµí†µ</option>
                    <option value="CAR">ìë™ì°¨</option>
                </select>
                <button class="btn btn-custom w-100 mb-2" id="add-waypoint">ê²½ìœ ì§€ ì¶”ê°€</button>
                <button class="btn btn-custom w-100 mt-2" id="get-route">ê¸¸ì°¾ê¸°</button>
                <!-- ê²½ë¡œ ì •ë³´ ì˜ì—­ -->
                <div class="scrollable2">
                    <div id="route-info" class="mt-3 p-2" style="background:#f1f3f5; border:1px solid #ddd; border-radius:6px;">
                        <strong>ê²½ë¡œ ì •ë³´</strong>
                        <div id="route-summary" style="margin-top:6px;">ê²€ìƒ‰ í›„ ê²½ë¡œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                        <ul id="route-steps" style="margin-top:6px; padding-left: 18px;"></ul>
                    </div> 
                </div>
            </div>
        </div>
        
        <!-- ì¼ì • ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="mt-4 schedule-section" id="schedule-section">
            <h6>ì¼ì • ê´€ë¦¬</h6>
            <div class="mb-2">
                <select id="daySelector" class="form-select form-select-sm"></select>
            </div>
            <div id="day-schedule"></div>
        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ -->
    <section class="flex-grow-1">
        <div id="map" class="w-100 h-100"></div>
    </section>
</div>

<!-- ì§€ë„ ìœ„ íˆ¬ëª… ì˜¤ë²„ë ˆì´ -->
<div id="overlay">
    <div id="sidebar" class="collapsed" aria-label="ì‚¬ì´ë“œë°”">
        <h2 class="sidebar-header">
            ì¥ì†Œ ë³´ê´€í•¨
            <div class="header-buttons">
                <button id="recategorizePlaces" class="recategorize-button" title="ì¹´í…Œê³ ë¦¬ ì¬ë¶„ë¥˜">
                    <i class="fas fa-rotate"></i>
                </button>
                <button id="resetSchedule" class="reset-button">ì´ˆê¸°í™”</button>
            </div>
        </h2>

        <!-- Day ì„ íƒ ë° ì¶”ê°€ -->
        <div class="sidebar-content">
            <div class="day-selector-section">
                <label for="sidebarDaySelector" class="day-selector-label">ğŸ“… ì¼ì • ì„ íƒ</label>
                <select id="sidebarDaySelector" class="form-select day-selector-dropdown">
                    <option value="Day1">Day 1</option>
                    <option value="Day2">Day 2</option>
                    <option value="Day3">Day 3</option>
                    <option value="Day4">Day 4</option>
                </select>
            </div>
            <button id="addDay" class="btn btn-sm btn-outline-primary mt-2 w-100">Day ì¶”ê°€</button>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ í† ê¸€ ì„¹ì…˜ -->
        <div id="category-sections">
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('ìˆ™ì†Œ')">
                    <span>ğŸ¨ ìˆ™ì†Œ</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="category-content" id="ìˆ™ì†Œ-content">
                    <div class="place-list" id="ìˆ™ì†Œ-list"></div>
                </div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('ì‹ë‹¹')">
                    <span>ğŸ½ï¸ ì‹ë‹¹</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="category-content" id="ì‹ë‹¹-content">
                    <div class="place-list" id="ì‹ë‹¹-list"></div>
                </div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('ì¹´í˜')">
                    <span>â˜• ì¹´í˜</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="category-content" id="ì¹´í˜-content">
                    <div class="place-list" id="ì¹´í˜-list"></div>
                </div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('ê´€ê´‘ì§€')">
                    <span>ğŸ›ï¸ ê´€ê´‘ì§€</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="category-content" id="ê´€ê´‘ì§€-content">
                    <div class="place-list" id="ê´€ê´‘ì§€-list"></div>
                </div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('ê¸°íƒ€')">
                    <span>ğŸ“ ê¸°íƒ€</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="category-content" id="ê¸°íƒ€-content">
                    <div class="place-list" id="ê¸°íƒ€-list"></div>
                </div>
            </div>
        </div>
    </div>
    <button id="toggleBtn" aria-label="ì‚¬ì´ë“œë°” í† ê¸€">â‰¡</button>
</div>

<!-- ë¡œë“œë·° ì»¨í…Œì´ë„ˆ -->
<div id="roadviewContainer" class="collapsed">
    <div id="roadviewHeader">
        <span>ë¡œë“œë·°</span>
        <button id="toggleRoadview">â–²</button>
    </div>
    <div id="roadview" class="roadview"></div>
</div>


{% if kakao_js_key %}
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services,roadview"></script>
{% else %}
<script>
console.error('âŒ ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ ì—†ì–´ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
</script>
{% endif %}

<!-- ì§€ë„ í˜ì´ì§€ ì „ìš© JavaScript -->
<script src="{% static 'js/constants.js' %}"></script>
<script src="{% static 'js/map.js' %}"></script>
<script src="{% static 'js/map-server.js' %}"></script>

<!-- ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” -->
<script>
// ë””ë²„ê¹…: API í‚¤ í™•ì¸
const kakaoJsKey = '{{ kakao_js_key|default:"" }}';
console.log('ğŸ” API í‚¤ í™•ì¸:', kakaoJsKey);
console.log('ğŸ” API í‚¤ ê¸¸ì´:', kakaoJsKey.length);
console.log('ğŸ” API í‚¤ íƒ€ì…:', typeof kakaoJsKey);

{% if kakao_js_key %}
// ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
kakao.maps.load(function() {
    console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ');
    
    // ì§€ë„ ì´ˆê¸°í™” (map.jsì˜ initializeMap)
    initializeMap();
    
    // ë¡œë“œë·° ì´ˆê¸°í™”
    initializeRoadview();
    
    // ì±—ë´‡ ì¼ì • ë°ì´í„° ë¡œë“œ
    console.log('ğŸ”„ loadChatbotSchedule() í˜¸ì¶œ ì¤‘...');
    loadChatbotSchedule();
});
{% else %}
console.error('âŒ ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤!');
console.error('KAKAO_JS_API_KEY í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
{% endif %}
</script>

{% endblock %}
